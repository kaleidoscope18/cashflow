package graph

// This file will be automatically regenerated based on the schema, any resolver implementations
// will be copied through when generating and any unknown code will be moved to the end.
// Code generated by github.com/99designs/gqlgen version v0.17.46

import (
	"cashflow/api/graph/generated"
	"cashflow/models"
	"cashflow/utils"
	"context"
	"fmt"
	"strings"
	"time"
)

// CreateTransaction is the resolver for the createTransaction field.
func (r *mutationResolver) CreateTransaction(ctx context.Context, input generated.NewTransaction) (*models.Transaction, error) {
	if input.Description == nil {
		return (*r.TransactionService).WriteTransaction(input.Date, input.Amount, "")
	}
	return (*r.TransactionService).WriteTransaction(input.Date, input.Amount, *input.Description)
}

// CreateTransactions is the resolver for the createTransactions field.
func (r *mutationResolver) CreateTransactions(ctx context.Context, input []*generated.NewTransaction) ([]*models.Transaction, error) {
	results := make([]*models.Transaction, 0)

	for _, transaction := range input {
		if transaction.Description == nil {
			t, err := (*r.TransactionService).WriteTransaction(transaction.Date, transaction.Amount, "")
			if err == nil {
				results = append(results, t)
			}
		} else {
			t, err := (*r.TransactionService).WriteTransaction(transaction.Date, transaction.Amount, *transaction.Description)
			if err == nil {
				results = append(results, t)
			}
		}
	}

	return results, nil
}

// DeleteTransaction is the resolver for the deleteTransaction field.
func (r *mutationResolver) DeleteTransaction(ctx context.Context, id string) (string, error) {
	return (*r.TransactionService).DeleteTransaction(ctx, id)
}

// DeleteTransactions is the resolver for the deleteTransactions field.
func (r *mutationResolver) DeleteTransactions(ctx context.Context, ids []string) ([]string, error) {
	results := make([]string, 0)
	errors := make([]string, 0)

	var err error
	for _, id := range ids {
		deletedId, err := (*r.TransactionService).DeleteTransaction(ctx, id)
		if err == nil {
			results = append(results, deletedId)
		}
		if err != nil {
			errors = append(errors, id)
		}
	}

	if len(errors) != 0 {
		err = fmt.Errorf("transactions that were deleted: %s - transactions not found: %s",
			strings.Join(results, ","),
			strings.Join(errors, ","),
		)
	}

	return results, err
}

// ListTransactions is the resolver for the listTransactions field.
func (r *queryResolver) ListTransactions(ctx context.Context, from *time.Time, to *time.Time) ([]*models.ComputedTransaction, error) {
	if from == nil || to == nil {
		err := fmt.Errorf("please provide from and to dates")
		return nil, err
	}

	result, err := (*r.TransactionService).ListTransactions(ctx, *from, *to)
	if err != nil {
		return nil, err
	}

	return utils.ConvertStructToPointersArray(result), nil
}
